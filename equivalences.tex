\chapter{等价性 (Equivalences)}
\label{cha:equivalences}

我们现在详细研究在\cref{sec:basics-equivalences}中简要介绍的\emph{类型的等价性 (equivalence of types)}概念。具体来说，我们将给出几种不同的方式来定义具有前述特性的一种类型 $\isequiv(f)$。回想一下，我们希望 $\isequiv(f)$ 具有以下性质，在此处我们再次陈述这些性质：
\begin{enumerate}
  \item $\qinv(f) \to \isequiv (f)$。\label{item:beb1}
  \item $\isequiv (f) \to \qinv(f)$。\label{item:beb2}
  \item $\isequiv(f)$ 是一个纯命题 (mere proposition)。\label{item:beb3}
\end{enumerate}
这里 $\qinv(f)$ 表示 $f$ 的准逆 (quasi-inverse) 类型：
\begin{equation*}
  \sm{g:B\to A} \big((f \circ g \htpy \idfunc[B]) \times (g\circ f \htpy \idfunc[A])\big)。
\end{equation*}
根据函数外延性 (function extensionality)，这意味着 $\qinv(f)$ 等价于类型
\begin{equation*}
  \sm{g:B\to A} \big((f \circ g = \idfunc[B]) \times (g\circ f = \idfunc[A])\big)。
\end{equation*}
我们将定义三种具有性质~\ref{item:beb1}--\ref{item:beb3} 的类型，分别称为：
\begin{itemize}
  \item 半伴随等价 (half adjoint equivalences)，
  \item 双可逆映射 (bi-invertible maps)，
  \index{function!bi-invertible}
  和
  \item 可缩函数 (contractible functions)。
\end{itemize}
我们还将证明这些类型是等价的。这些名称特意显得有些繁琐，因为在我们知道它们都是等价的并具有性质~\ref{item:beb1}--\ref{item:beb3}之后，我们会简单地使用“等价性 (equivalence)”这个词，而不需要指定我们选择了哪种特定定义。但为了本章中的比较目的，我们需要为每个定义提供不同的名称。

在我们研究等价性的不同概念之前，我们先稍微解释一下为什么需要一个不同于准可逆性的概念。

\section{准逆 (Quasi-inverses)}
\label{sec:quasi-inverses}

\index{quasi-inverse|(}%
我们已经提到 $\qinv(f)$ 是不令人满意的，因为它不是一个纯命题，而我们希望一个给定的函数最多以一种方式“成为等价的”。然而，我们还没有证明 $\qinv(f)$ 不是一个纯命题。在本节中，我们展示一个具体的反例。

\begin{lem}\label{lem:qinv-autohtpy}
如果 $f:A\to B$ 是使得 $\qinv (f)$ 可居住的 (inhabited)，那么
\[\eqv{\qinv(f)}{\Parens{\prd{x:A}(x=x)}}。\]
\end{lem}
\begin{proof}
  根据假设，$f$ 是一个等价性，也就是说我们有 $e:\isequiv(f)$，因此 $(f,e):\eqv A B$。根据单值性 (univalence)，$\idtoeqv:(A=B) \to (\eqv A B)$ 是一个等价性，因此我们可以假设 $(f,e)$ 的形式为 $\idtoeqv(p)$，其中 $p:A=B$。然后根据路径归纳 (path induction)，我们可以假设 $p$ 是 $\refl{A}$，在这种情况下，$f$ 是 $\idfunc[A]$。因此，我们简化为证明 $\eqv{\qinv(\idfunc[A])}{(\prd{x:A}(x=x))}$。现在，根据定义，我们有
  \[ \qinv(\idfunc[A]) \jdeq
  \sm{g:A\to A} \big((g \htpy \idfunc[A]) \times (g \htpy \idfunc[A])\big)。
  \]
  根据函数外延性，这等价于
  \[ \sm{g:A\to A} \big((g = \idfunc[A]) \times (g = \idfunc[A])\big)。
  \]
  根据 \cref{ex:sigma-assoc}，这等价于
  \[ \sm{h:\sm{g:A\to A} (g = \idfunc[A])} (\proj1(h) = \idfunc[A])。
  \]
  然而，根据 \cref{thm:contr-paths}，$\sm{g:A\to A} (g = \idfunc[A])$ 是以 $(\idfunc[A],\refl{\idfunc[A]})$ 为中心的可缩 (contractible) 类型；因此根据 \cref{thm:omit-contr}，这个类型等价于 $\idfunc[A] = \idfunc[A]$。根据函数外延性，$\idfunc[A] = \idfunc[A]$ 等价于 $\prd{x:A} x=x$。
\end{proof}

\noindent
我们注意到 \cref{ex:qinv-autohtpy-no-univalence} 要求在避免单值性的情况下证明上述引理。

因此，我们需要一些 $A$，它允许 $\prd{x:A}(x=x)$ 的非平凡 (nontrivial) 元素。将 $A$ 视为一个更高阶的群胚 (higher groupoid)，$\prd{x:A}(x=x)$ 的一个居留元素 (inhabitant) 是从 $A$ 的恒等函子 (identity functor) 到其自身的自然变换 (natural transformation)。这样的变换被称为一个范畴的\define{中心 (center of a category)}，\index{center!of a category}%
\index{category!center of}%
因为自然性公理要求它们与所有态射 (morphisms) 交换。传统上，如果 $A$ 只是一个被视为单对象群胚 (one-object groupoid) 的群体，那么这将恰好得出通常群论意义上的中心。这为以下内容提供了一些动机。

\begin{lem}\label{lem:autohtpy}
假设我们有一个类型 $A$ 和 $a:A$ 以及 $q:a=a$，使得
\begin{enumerate}
  \item 类型 $a=a$ 是一个集合 (set)。\label{item:autohtpy1}
  \item 对于所有 $x:A$，我们有 $\brck{a=x}$。\label{item:autohtpy2}
  \item 对于所有 $p:a=a$，我们有 $p\ct q = q \ct p$。\label{item:autohtpy3}
\end{enumerate}
那么存在 $f:\prd{x:A} (x=x)$，且有 $f(a)=q$。
\end{lem}
\begin{proof}
  令 $g:\prd{x:A} \brck{a=x}$ 为~\ref{item:autohtpy2}给出的值。首先我们
  观察到每个类型 $\id[A]xy$ 是一个集合。因为作为一个集合是一个纯命题，我们可以应用命题截断 (propositional truncation) 的归纳原则，假设 $g(x)=\bproj
  p$ 且 $g(y)=\bproj{p'}$，其中 $p:a=x$ 和 $p':a=y$。在这种情况下，与
  $p$ 和 $\opp{p'}$ 组成的映射等价于 $\eqv{(x=y)}{(a=a)}$。但由于~\ref{item:autohtpy1} 中 $(a=a)$ 是一个集合，因此 $(x=y)$ 也是一个集合。

  现在，我们希望通过为每个 $x$ 分配路径 $\opp{g(x)}
  \ct q \ct g(x)$ 来定义 $f$，但这不奏效，因为 $g(x)$ 不属于 $a=x$，而是 $\brck{a=x}$，并且类型 $(x=x)$ 可能不是一个纯命题，因此我们不能使用命题截断的归纳法。相反，我们可以应用 \cref{sec:unique-choice} 中提到的技巧：我们唯一地刻画我们希望构造的对象。让我们定义，对于每个 $x:A$，类型
  \[ B(x) \defeq \sm{r:x=x} \prd{s:a=x} (r = \opp s \ct q\ct s)。\]
  我们声称每个 $B(x)$ 是一个纯命题。
  由于这个声明本身是一个纯命题，我们可以再次应用命题截断的归纳法，并假设 $g(x) = \bproj p$，其中 $p:a=x$。
  现在假设给定 $(r,h)$ 和 $(r',h')$ 在 $B(x)$ 中；然后我们有
  \[ h(p) \ct \opp{h'(p)} : r = r'。\]
  剩下的是展示，当沿着这个等式传递时，$h$ 与 $h'$ 相同，这通过在恒等类型和函数类型中传输 (\cref{sec:compute-paths,sec:compute-pi})，减少为展示
  \[ h(s) = h(p) \ct \opp{h'(p)} \ct h'(s) \]
  对于任何 $s:a=x$。
  但这两侧都是 $(x=x)$ 的元素之间的等式，因此它遵循我们之前的观察，即 $(x=x)$ 是一个集合。

  因此，每个 $B(x)$ 是一个纯命题；我们声称 $\prd{x:A} B(x)$。
  给定 $x:A$，我们现在可以调用命题截断的归纳法，假设 $g(x) = \bproj p$，其中 $p:a=x$。
  我们定义 $r \defeq \opp p \ct q \ct p$；为了填充 $B(x)$，剩下的是展示对于任何 $s:a=x$ 我们有
  $r = \opp s \ct q \ct s$。
  操作路径，这减少为展示 $q\ct (p\ct \opp s) = (p\ct \opp s) \ct q$。
  但这只是~\ref{item:autohtpy3} 的一个实例。
\end{proof}

\begin{thm}\label{thm:qinv-notprop}
存在类型 $A$ 和 $B$ 以及一个函数 $f:A\to B$ 使得 $\qinv(f)$ 不是一个纯命题。
\end{thm}
\begin{proof}
  这足以展示一个类型 $X$，使得 $\prd{x:X} (x=x)$ 不是一个纯命题。
  定义 $X\defeq \sm{A:\type} \brck{\bool=A}$，如在 \cref{thm:no-higher-ac} 的证明中所述。
  展示一个 $f:\prd{x:X} (x=x)$，它不同于 $\lam{x} \refl{x}$ 即可。

  令 $a \defeq (\bool,\bproj{\refl{\bool}}) : X$，并令 $q:a=a$ 是对应于非恒等的等价性 $e:\eqv\bool\bool$ 的路径，其定义为 $e(\bfalse)\defeq\btrue$ 和 $e(\btrue)\defeq\bfalse$。
  我们希望应用 \cref{lem:autohtpy} 来构建一个 $f$。
  根据 $X$ 的定义，子集类型中的等式 (\cref{subsec:prop-subsets}) 和单值性，我们有 $\eqv{(a=a)}{(\eqv{\bool}{\bool})}$，这是一个集合，因此~\ref{item:autohtpy1} 成立。
  类似地，根据 $X$ 的定义和子集类型中的等式，我们有~\ref{item:autohtpy2}。
  最后，\cref{ex:eqvboolbool} 表明每个等价性 $\eqv\bool\bool$ 都等于 $\idfunc[\bool]$ 或 $e$，因此我们可以通过四种情况分析展示~\ref{item:autohtpy3}。

  因此，我们有 $f:\prd{x:X} (x=x)$，且有 $f(a) = q$。
  由于 $e$ 不等于 $\idfunc[\bool]$，$q$ 不等于 $\refl{a}$，因此 $f$ 不等于 $\lam{x} \refl{x}$。
  因此，$\prd{x:X} (x=x)$ 不是一个纯命题。
\end{proof}

更普遍地，\cref{lem:autohtpy} 表明任何“Eilenberg--Mac Lane 空间 (Eilenberg--Mac Lane space)” $K(G,1)$，其中 $G$ 是一个非平凡的阿贝尔 (abelian) 群体，将提供一个反例；参见 \cref{cha:homotopy}。我们使用的类型 $X$ 结果是等价于 $K(\mathbb{Z}_2,1)$。在 \cref{cha:hits} 中，我们将看到圆 $S^1 = K(\mathbb{Z},1)$ 是另一个易于描述的例子。

我们现在继续描述更好的等价性概念。

\index{quasi-inverse|)}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{半伴随等价 (Half adjoint equivalences)}
\label{sec:hae}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{equivalence!half adjoint|(defstyle}%
\index{half adjoint equivalence|(defstyle}%
\index{adjoint!equivalence!of types, half|(defstyle}%

在 \cref{sec:quasi-inverses} 中，我们得出结论认为 $\qinv(f)$ 通过丢弃一个可缩类型等价于 $\prd{x:A} (x=x)$。粗略地说，类型 $\qinv(f)$ 包含三个数据 $g$、$\eta$ 和 $\epsilon$，其中两个 ($g$ 和 $\eta$) 可以一起在 $f$ 是等价性时被视为可缩的。问题在于去掉这些数据后还剩下一个 ($\epsilon$)。为了解决这个问题，想法是增加一个\emph{额外的}数据，这样 $\epsilon$ 和它一起构成一个可缩类型。

\begin{defn}\label{defn:ishae}
一个函数 $f:A\to B$ 是一个\define{半伴随等价 (half adjoint equivalence)}，
如果存在 $g:B\to A$ 和同伦 $\eta: g \circ f \htpy \idfunc[A]$ 和 $\epsilon:f \circ g \htpy \idfunc[B]$，使得存在一个同伦
\[\tau : \prd{x:A} \map{f}{\eta x} = \epsilon(fx)。\]
\end{defn}

因此我们定义类型 $\ishae(f)$ 为
\begin{equation*}
  \sm{g:B\to A}{\eta: g \circ f \htpy \idfunc[A]}{\epsilon:f \circ g \htpy \idfunc[B]} \prd{x:A} \map{f}{\eta x} = \epsilon(fx)。
\end{equation*}
注意在上述定义中，$\eta$ 和 $\epsilon$ 的一致性条件 (coherence condition) 仅涉及 $f$。我们可以考虑一个涉及 $g$ 的类似一致性条件：
\[\upsilon : \prd{y:B} \map{g}{\epsilon y} = \eta(gy)\]
并得到一个类似的定义 $\ishae'(f)$。

幸运的是，事实证明这些条件中的每一个都意味着另一个：

\begin{lem}\label{lem:coh-equiv}
对于函数 $f : A \to B$ 和 $g:B\to A$ 以及同伦 $\eta: g \circ f \htpy \idfunc[A]$ 和 $\epsilon:f \circ g \htpy \idfunc[B]$，以下条件是逻辑等价的：
\begin{itemize}
  \item $\prd{x:A} \map{f}{\eta x} = \epsilon(fx)$
  \item $\prd{y:B} \map{g}{\epsilon y} = \eta(gy)$
\end{itemize}
\end{lem}
\begin{proof}
  证明一个方向就足够了；另一个方向通过替换 $A$、$f$ 和 $\eta$ 为 $B$、$g$ 和 $\epsilon$ 分别得到。
  设 $\tau : \prd{x:A}\;\map{f}{\eta x} = \epsilon(fx)$。
  固定 $y : B$。
  使用 $\epsilon$ 的自然性 (naturality) 并应用 $g$，我们得到以下路径的交换图：
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix@C=3pc{gfgfgy \ar@{=}^-{gfg(\epsilon y)}[r] \ar@{=}_{g(\epsilon (fgy))}[d] & gfgy \ar@{=}^{g(\epsilon y)}[d] \\ gfgy \ar@{=}_{g(\epsilon y)}[r] & gy
  }\]
  在图的左侧使用 $\tau(gy)$ 得到
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix@C=3pc{gfgfgy \ar@{=}^-{gfg(\epsilon y)}[r] \ar@{=}_{gf(\eta (gy))}[d] & gfgy \ar@{=}^{g(\epsilon y)}[d] \\ gfgy \ar@{=}_{g(\epsilon y)}[r] & gy
  }\]
  使用 $\eta$ 与 $g \circ f$ 的交换 (\cref{cor:hom-fg})，我们有
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix@C=3pc{gfgfgy \ar@{=}^-{gfg(\epsilon y)}[r] \ar@{=}_{\eta (gfgy)}[d] & gfgy \ar@{=}^{g(\epsilon y)}[d] \\ gfgy \ar@{=}_{g(\epsilon y)}[r] & gy
  }\]
  然而，根据 $\eta$ 的自然性，我们也有
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix@C=3pc{gfgfgy \ar@{=}^-{gfg(\epsilon y)}[r] \ar@{=}_{\eta (gfgy)}[d] & gfgy \ar@{=}^{\eta(gy)}[d] \\ gfgy \ar@{=}_{g(\epsilon y)}[r] & gy
  }\]
  因此，取消所有但右侧的同伦，我们得到 $g(\epsilon y) = \eta(g y)$ 如所期望的。
\end{proof}

然而，重要的是我们不要在 $\ishae (f)$ 的定义中包含\emph{两者} $\tau$ 和 $\upsilon$（因此称之为“\emph{半}伴随等价 (half adjoint equivalence)”）。如果我们这么做，那么在取消可缩类型后，我们仍然会剩下一个数据——除非我们添加另一个更高的一致性条件。一般来说，如果我们在一个奇数个一致性条件之后切断，我们预期会得到一个良好行为的类型。

当然，很明显 $\ishae(f) \to\qinv(f)$：只需忘记一致性数据。另一个方向是同伦理论 (homotopy theory) 和范畴论 (category theory) 中的标准论点的一种版本。

\begin{thm}\label{thm:equiv-iso-adj}
对于任何 $f:A\to B$，我们有 $\qinv(f)\to\ishae(f)$。
\end{thm}
\begin{proof}
  假设 $(g,\eta,\epsilon)$ 是 $f$ 的准逆 (quasi-inverse)。我们必须提供一个四元组 $(g',\eta',\epsilon',\tau)$ 来证明 $f$ 是一个半伴随等价 (half adjoint equivalence)。为了定义 $g'$ 和 $\eta'$，我们可以选择显而易见的选择，将 $g'
  定义为 $g$，将 $\eta'定义为 $\eta$。然而，在 $\epsilon'$ 的定义中，我们需要开始考虑 $\tau$ 的构造，因此不能直接按照常规选择 $\epsilon'$ 为 $\epsilon$。相反，我们选择
  \begin{equation*}
    \epsilon'(b) \defeq \opp{\epsilon(f(g(b)))}\ct (\ap{f}{\eta(g(b))}\ct \epsilon(b))。
  \end{equation*}
  现在我们需要找到
  \begin{equation*}
    \tau(a): \ap{f}{\eta(a)}=\opp{\epsilon(f(g(f(a))))}\ct (\ap{f}{\eta(g(f(a)))}\ct \epsilon(f(a)))。
  \end{equation*}
  首先注意到，根据 \cref{cor:hom-fg}，我们有
%$\eta(g(f(a)))\ct\eta(a)=\ap{g}{\ap{f}{\eta(a)}}\ct\eta(a)$ 并因此它遵循 $\eta(g(f(a)))=\ap{g}{\ap{f}{\eta(a)}}$。因此，我们可以应用
  \cref{lem:htpy-natural} 计算
  \begin{align*}
    \ap{f}{\eta(g(f(a)))}\ct \epsilon(f(a))
    & = \ap{f}{\ap{g}{\ap{f}{\eta(a)}}}\ct \epsilon(f(a))\\
    & = \epsilon(f(g(f(a))))\ct \ap{f}{\eta(a)}
  \end{align*}
  从而得到所需的路径 $\tau(a)$。
\end{proof}

结合 \cref{lem:coh-equiv}（或对称化的证明），我们也有 $\qinv(f)\to\ishae'(f)$。

剩下的是展示 $\ishae(f)$ 是一个纯命题。
为此，我们需要知道等价性的纤维 (fiber) 是可缩的。

\begin{defn}\label{defn:homotopy-fiber}
函数 $f:A\to B$ 在点 $y:B$ 上的\define{纤维 (fiber)}
\indexdef{fiber}%
\indexsee{function!fiber of}{fiber}%
定义为
\[ \hfib f y \defeq \sm{x:A} (f(x) = y)。\]
\end{defn}

在同伦理论中，这被称为 $f$ 的\emph{同伦纤维 (homotopy fiber)}。
\cref{sec:computational} 中的路径引理得出以下关于纤维中路径的刻画：

\begin{lem}\label{lem:hfib}
对于任何 $f : A \to B$、$y : B$ 以及 $(x,p),(x',p') : \hfib{f}{y}$，我们有
\[ \big((x,p) = (x',p')\big) \eqvsym \Parens{\sm{\gamma : x = x'} f(\gamma) \ct p' = p} \qedhere\]
\end{lem}

\begin{thm}\label{thm:contr-hae}
如果 $f:A\to B$ 是一个半伴随等价，那么对于任何 $y:B$，纤维 $\hfib f y$ 是可缩的。
\end{thm}
\begin{proof}
  令 $(g,\eta,\epsilon,\tau) : \ishae(f)$，并固定 $y : B$。
  作为 $\hfib{f}{y}$ 的缩并中心 (center of contraction)，我们选择 $(gy, \epsilon y)$。
  现在取任何 $(x,p) : \hfib{f}{y}$；我们要构造从 $(gy, \epsilon y)$ 到 $(x,p)$ 的路径。
  根据 \cref{lem:hfib}，足以给出一个路径 $\gamma : \id{gy}{x}$，使得 $\ap f\gamma \ct p = \epsilon y$。
  我们取 $\gamma \defeq \opp{g(p)} \ct \eta x$。
  然后我们有
  \begin{align*}
    f(\gamma) \ct p & = \opp{fg(p)} \ct f (\eta x) \ct p \\
    & = \opp{fg(p)} \ct \epsilon(fx) \ct p \\
    & = \epsilon y
  \end{align*}
  其中第二个等式由 $\tau x$ 得到，第三个等式是 $\epsilon$ 的自然性。
\end{proof}

我们现在定义封装可缩数据对的类型。
以下类型将准逆 $g$ 与其中一个同伦结合起来。

\begin{defn}\label{defn:linv-rinv}
给定一个函数 $f:A\to B$，我们定义类型
\begin{align*}
  \linv(f) &\defeq \sm{g:B\to A} (g\circ f\htpy \idfunc[A])\\
  \rinv(f) &\defeq \sm{g:B\to A} (f\circ g\htpy \idfunc[B])
\end{align*}
分别为 $f$ 的\define{左逆 (left inverses)}
\indexdef{left!inverse}%
\indexdef{inverse!left}%
和\define{右逆 (right inverses)}。
如果 $\linv(f)$ 可居住，我们称 $f$ 是\define{左可逆 (left invertible)}的，如果 $\rinv(f)$ 可居住，我们称 $f$ 是\define{右可逆 (right invertible)}的。
\end{defn}

\begin{lem}\label{thm:equiv-compose-equiv}
如果 $f:A\to B$ 有一个准逆，那么以下映射也有准逆：
\begin{align*}
(f\circ \blank) &: (C\to A) \to (C\to B)\\
(\blank\circ f) &: (B\to C) \to (A\to C)。
\end{align*}
\end{lem}
\begin{proof}
  如果 $g$ 是 $f$ 的准逆，那么 $(g\circ \blank)$ 和 $(\blank\circ g)$ 分别是 $(f\circ \blank)$ 和 $(\blank\circ f)$ 的准逆。
\end{proof}

\begin{lem}\label{lem:inv-hprop}
如果 $f : A \to B$ 有一个准逆，那么类型 $\rinv(f)$ 和 $\linv(f)$ 是可缩的。
\end{lem}
\begin{proof}
  根据函数外延性，我们有
  \[\eqv{\linv(f)}{\sm{g:B\to A} (g\circ f = \idfunc[A])}。\]
  但这是 $\Sigma$ 的纤维 (fiber) (\cref{subsec:prop-subsets})，因此
  根据 \cref{thm:equiv-compose-equiv,thm:equiv-iso-adj,thm:contr-hae}，它是可缩的。
  类似地，$\rinv(f)$ 等价于 $\Sigma$ 上的 $\idfunc[B]$ 的纤维 (fiber)，因此也是可缩的。
\end{proof}

接下来，我们定义将另一个同伦与额外的一致性数据结合起来的类型。\index{coherence}%

\begin{defn}\label{defn:lcoh-rcoh}
对于 $f : A \to B$，一个左逆 $(g,\eta) : \linv(f)$ 和一个右逆 $(g,\epsilon) : \rinv(f)$，我们表示
\begin{align*}
  \lcoh{f}{g}{\eta} & \defeq \sm{\epsilon : f\circ g \htpy \idfunc[B]} \prd{y:B} g(\epsilon y) = \eta (gy)， \\
  \rcoh{f}{g}{\epsilon} & \defeq \sm{\eta : g\circ f \htpy \idfunc[A]} \prd{x:A} f(\eta x) = \epsilon (fx)。
\end{align*}
\end{defn}

\begin{lem}\label{lem:coh-hfib}
对于任何 $f,g,\epsilon,\eta$，我们有
\begin{align*}
  \lcoh{f}{g}{\eta} & \eqvsym {\prd{y:B} \id[\hfib{g}{gy}]{(fgy,\eta(gy))}{(y,\refl{gy})}}， \\
  \rcoh{f}{g}{\epsilon} & \eqvsym {\prd{x:A} \id[\hfib{f}{fx}]{(gfx,\epsilon(fx))}{(x,\refl{fx})}}。
\end{align*}
\end{lem}
\begin{proof}
  使用 \cref{lem:hfib}。
\end{proof}

\begin{lem}\label{lem:coh-hprop}
如果 $f$ 是一个半伴随等价，那么对于任何 $(g,\epsilon) : \rinv(f)$，类型 $\rcoh{f}{g}{\epsilon}$ 是可缩的。
\end{lem}
\begin{proof}
  根据 \cref{lem:coh-hfib} 和从属函数类型保持可缩空间的事实，足以展示对于每个 $x:A$，类型 $\id[\hfib{f}{fx}]{(gfx,\epsilon(fx))}{(x,\refl{fx})}$ 是可缩的。
  但根据 \cref{thm:contr-hae}，$\hfib{f}{fx}$ 是可缩的，并且任何可缩空间的路径空间本身就是可缩的。
\end{proof}

\begin{thm}\label{thm:hae-hprop}
对于任何 $f : A \to B$，类型 $\ishae(f)$ 是一个纯命题。
\end{thm}
\begin{proof}
  根据 \cref{ex:prop-inhabcontr}，假设 $f$ 是一个半伴随等价，并展示 $\ishae(f)$ 是可缩的就足够了。
  现在根据 $\Sigma$ 的结合律 (\cref{ex:sigma-assoc})，类型 $\ishae(f)$ 等价于
  \[\sm{u : \rinv(f)} \rcoh{f}{\proj{1}(u)}{\proj{2}(u)}。\]
  但根据 \cref{lem:inv-hprop,lem:coh-hprop} 和 $\Sigma$ 保持可缩性的事实，后者类型也是可缩的。
\end{proof}

因此，我们已经证明 $\ishae(f)$ 具有作为类型 $\isequiv(f)$ 的所有三种特性。
在接下来的两节中，我们将讨论一些其他可能性。

\index{equivalence!half adjoint|)}%
\index{half adjoint equivalence|)}%
\index{adjoint!equivalence!of types, half|)}%

\section{双可逆映射 (Bi-invertible maps)}
\label{sec:biinv}

\index{function!bi-invertible|(defstyle}%
\index{bi-invertible function|(defstyle}%
\index{equivalence!as bi-invertible function|(defstyle}%

使用在 \cref{sec:hae} 引入的语言，我们可以重新表述在 \cref{sec:basics-equivalences} 提出的定义，如下所示。

\begin{defn}\label{defn:biinv}
我们说 $f:A\to B$ 是 \define{双可逆 (bi-invertible)} 映射，
如果它同时具有左逆元和右逆元：
\[ \biinv (f) \defeq \linv(f) \times \rinv(f). \]
\end{defn}

在 \cref{sec:basics-equivalences} 中，我们证明了 $\qinv(f)\to\biinv(f)$ 和 $\biinv(f)\to\qinv(f)$。
剩下的是以下内容。

\begin{thm}\label{thm:isprop-biinv}
对于任意 $f:A\to B$，类型 $\biinv(f)$ 是一个单纯命题 (mere proposition)。
\end{thm}
\begin{proof}
  我们假设 $f$ 是双可逆的并证明 $\biinv(f)$ 是收缩的 (contractible)。
  但由于 $\biinv(f)\to\qinv(f)$，根据 \cref{lem:inv-hprop}，在这种情况下 $\linv(f)$ 和 $\rinv(f)$ 都是收缩的，而收缩类型的乘积也是收缩的。
\end{proof}

注意，这也符合在 \cref{sec:hae} 开头提出的建议：我们将 $g$ 和 $\eta$ 组合成一个收缩类型，并添加一个额外的数据，它与 $\epsilon$ 组合成一个收缩类型。
不同之处在于，我们没有添加一个 \emph{更高的} 数据（一个二维路径）来与 $\epsilon$ 组合，而是添加了一个 \emph{更低的} 数据（一个与左逆元分开的右逆元）。

\begin{cor}\label{thm:equiv-biinv-isequiv}
对于任意 $f:A\to B$，我们有 $\eqv{\biinv(f)}{\ishae(f)}$。
\end{cor}
\begin{proof}
  我们有 $\biinv(f) \to \qinv(f) \to \ishae(f)$ 和 $\ishae(f) \to \qinv(f) \to \biinv(f)$。
  由于 $\ishae(f)$ 和 $\biinv(f)$ 都是单纯命题，因此根据 \cref{lem:equiv-iff-hprop} 可以得出等价性。
\end{proof}

\index{function!bi-invertible|)}%
\index{bi-invertible function|)}%
\index{equivalence!as bi-invertible function|)}%

\section{收缩纤维 (Contractible fibers)}
\label{sec:contrf}

\index{function!contractible|(defstyle}%
\index{contractible!function|(defstyle}%
\index{equivalence!as contractible function|(defstyle}%

注意，我们关于 $\ishae(f)$ 和 $\biinv(f)$ 的证明中，使用了等价的纤维是收缩的这一事实。
实际上，这个性质本身就是等价的一个充分定义。

\begin{defn}[收缩映射 (Contractible maps)] \label{defn:equivalence}
映射 $f:A\to B$ 是 \define{收缩的 (contractible)}，
如果对所有 $y:B$，纤维 $\hfib f y$ 是收缩的。
\end{defn}

因此，类型 $\iscontr(f)$ 被定义为
\begin{align}
  \iscontr(f) &\defeq \prd{y:B} \iscontr(\hfib f y)\label{eq:iscontrf}
  % \\
  % &\defeq \prd{y:B} \iscontr (\setof{x:A | f(x) = y}).
\end{align}
注意，在 \cref{sec:contractibility} 中，我们定义了 \emph{类型} 收缩的含义。
在这里，我们定义了 \emph{映射} 收缩的含义。
我们的术语遵循一般同伦理论的实践，即如果一个映射的所有（同伦）纤维都具有某个性质，则该映射具有该性质。
因此，当映射 $A\to\unit$ 是收缩的时，类型 $A$ 是收缩的。
从 \cref{cha:hlevels} 开始，我们也会称收缩映射和类型为 \emph{$(-2)$-截断的 ($(-2)$-truncated)}。

我们已经在 \cref{thm:contr-hae} 中展示了 $\ishae(f) \to \iscontr(f)$。
反之亦然：

\begin{thm}\label{thm:lequiv-contr-hae}
对于任意 $f:A\to B$ 我们有 ${\iscontr(f)} \to {\ishae(f)}$。
\end{thm}
\begin{proof}
  让 $P : \iscontr(f)$。我们通过将每个 $y : B$ 映射到 $y$ 处纤维的收缩中心来定义一个逆映射 $g : B \to A$：
  \[ g(y) \defeq \proj{1}(\proj{1}(Py))。\]
  因此，我们可以通过将 $y$ 映射到 $g(y)$ 确实属于 $y$ 处纤维的见证，来定义同伦 $\epsilon$：
  \[ \epsilon(y) \defeq \proj{2}(\proj{1}(P y))。\]
  剩下的是定义 $\eta$ 和 $\tau$。这当然意味着给出一个 $\rcoh{f}{g}{\epsilon}$ 的元素。根据 \cref{lem:coh-hfib}，这相当于给出对于每个 $x:A$，从 $f$ 在 $fx$ 处的纤维中的 $(gfx,\epsilon(fx))$ 到 $(x,\refl{fx})$ 的路径。但这很简单：对于任意 $x : A$，类型 $\hfib{f}{fx}$ 根据假设是收缩的，因此这样的路径必须存在。我们可以显式地构造它为
  \[\opp{\big(\proj{2}(P(fx))(gfx,\epsilon(fx))\big)} \ct \big(\proj{2}(P(fx)) (x,\refl{fx})\big). \qedhere \]
\end{proof}

同样容易看出：

\begin{lem}\label{thm:contr-hprop}
对于任意 $f$，类型 $\iscontr(f)$ 是一个单纯命题。
\end{lem}
\begin{proof}
  根据 \cref{thm:isprop-iscontr}，每个类型 $\iscontr (\hfib f y)$ 是一个单纯命题。
  因此，根据 \cref{thm:isprop-forall}，\eqref{eq:iscontrf} 也是如此。
\end{proof}

\begin{thm}\label{thm:equiv-contr-hae}
对于任意 $f:A\to B$ 我们有 $\eqv{\iscontr(f)}{\ishae(f)}$。
\end{thm}
\begin{proof}
  我们已经建立了 ${\iscontr(f)} \Leftrightarrow {\ishae(f)}$ 的逻辑等价关系，并且它们都是单纯命题 (\cref{thm:contr-hprop,thm:hae-hprop})。
  因此，\cref{lem:equiv-iff-hprop} 适用。
\end{proof}

通常，我们通过给出一个准逆元来证明一个函数是等价的，但有时这个定义更方便。
例如，它暗示了当证明一个函数是等价的时，我们可以假设它的陪域是非空的。

\begin{cor}\label{thm:equiv-inhabcod}
如果 $f:A\to B$ 使得 $B\to \isequiv(f)$，那么 $f$ 是等价的。
\end{cor}
\begin{proof}
  为了证明 $f$ 是等价的，足以证明对于任意 $y:B$，$\hfib f y$ 是收缩的。
  但是如果 $e:B\to \isequiv(f)$，那么对于任意 $y$，我们有 $e(y):\isequiv(f)$，因此 $f$ 是等价的，并且因此 $\hfib f y$ 是收缩的，如所需。
\end{proof}

\index{function!contractible|)}%
\index{contractible!function|)}%
\index{equivalence!as contractible function|)}%

\section{关于等价定义的思考 (On the definition of equivalences)}
\label{sec:concluding-remarks}

\indexdef{equivalence}
我们已经证明所有三个等价的定义满足三个理想的性质，并且它们是成对等价的：
\[ \iscontr(f) \eqvsym \ishae(f) \eqvsym \biinv(f). \]
（还有更多可能的等价定义，但我们将在此处讨论这三个。
参见 \cref{ex:brck-qinv} 和本章中的习题，以了解更多。）
因此，我们可以选择其中任何一个作为 $\isequiv (f)$ 的“定义”。
为了明确起见，我们选择定义
\[ \isequiv(f) \defeq \ishae(f)。\]
\index{mathematics!formalized}%
这个选择对形式化很有利，因为 $\ishae(f)$ 包含了最直接有用的数据。
另一方面，对于其他目的，$\biinv(f)$ 通常更容易处理，因为它不包含二维路径，并且它的两个对称部分可以独立处理。
然而，对于本书的目的，具体选择几乎没有区别。

在本章的其余部分，我们研究等价的一些其他性质和特征。
\index{equivalence!properties of}%


\section{满射与嵌入 (Surjections and embeddings)}
\label{sec:mono-surj}

\index{set}
当 $A$ 和 $B$ 是集合 (sets) 并且 $f:A\to B$ 是等价的时，我们也称它为 \define{同构 (isomorphism)}
\indexdef{isomorphism!of sets}%
或 \define{双射 (bijection)}。
\indexdef{bijection}%
\indexsee{function!bijective}{bijection}%
（对于不是集合的类型，我们避免使用这些词，因为在同伦理论和高阶范畴论中，它们通常表示比同伦等价更严格的“相同”概念。）
在集合论中，当且仅当一个函数既是单射 (injective) 又是满射 (surjective) 时，它是一个双射。
在类型论中也是如此，如果我们适当地表述这些条件。
为清楚起见，在处理非集合的类型时，我们将使用 \emph{嵌入 (embeddings)} 一词来代替单射。

\begin{defn}\label{defn:surj-emb}
设 $f:A\to B$。
\begin{enumerate}
  \item 我们说 $f$ 是 \define{满射 (surjective)}
  \indexsee{surjective!function}{function, surjective}%
  \indexdef{function!surjective}%
  （或称为 \define{满射 (surjection)}）
  \indexsee{surjection}{function, surjective}%
  如果对于每个 $b:B$，我们有 $\brck{\hfib f b}$。
  \item 我们说 $f$ 是一个 \define{嵌入 (embedding)}
  \indexdef{function!embedding}%
  \indexsee{embedding}{function, embedding}%
  如果对于每个 $x,y:A$，函数 $\apfunc f : (\id[A]xy) \to (\id[B]{f(x)}{f(y)})$ 是一个等价。
\end{enumerate}
\end{defn}

换句话说，如果 $f$ 的每个纤维只是居住的，或者等价地，如果对于所有 $b:B$，仅存在一个 $a:A$ 使得 $f(a)=b$，则 $f$ 是满射。
在传统逻辑符号中，如果 $\fall{b:B}\exis{a:A} (f(a)=b)$，则 $f$ 是满射。
这必须与更强的断言 $\prd{b:B}\sm{a:A} (f(a)=b)$ 区分开来；如果这成立，我们说 $f$ 是一个 \define{分裂满射 (split surjection)}。
\indexsee{split!surjection}{function, split surjective}%
\indexsee{surjection!split}{function, split surjective}%
\indexsee{surjective!function!split}{function, split surjective}%
\indexdef{function!split surjective}%
（因为这个后者的类型等价于 $\sm{g:B\to A}\prd{b:B} (f(g(b))=b)$，所以分裂满射与 \cref{sec:contractibility} 中定义的 \emph{再牵引 (retraction)} 是相同的。）
\index{retraction}%
\index{function!retraction}%

\cref{sec:axiom-choice} 中的选择公理 (axiom of choice) 恰好说明了每个 \emph{集合之间的} 满射都是分裂的。
然而，在单一性公理 (univalence axiom) 的存在下，简单地说，\emph{所有} 满射都不是分裂的。
在 \cref{thm:no-higher-ac} 中，我们构建了一个类型族 $Y:X\to \type$，使得 $\prd{x:X} \brck{Y(x)}$ 但 $\neg \prd{x:X} Y(x)$；
对于任何此类族，$Y$ 的第一次投影 $(\sm{x:X} Y(x)) \to X$ 是一个未分裂的满射。

如果 $A$ 和 $B$ 是集合，那么根据 \cref{lem:equiv-iff-hprop}，当且仅当
\begin{equation}
  \prd{x,y:A} (\id[B]{f(x)}{f(y)}) \to (\id[A]xy).\label{eq:injective}
\end{equation}
时，$f$ 是嵌入的。
在这种情况下，我们说 $f$ 是 \define{单射 (injective)}，
\indexsee{injective function}{function, injective}%
\indexdef{function!injective}%
或 \define{单射 (injection)}。
\indexsee{injection}{function, injective}%
对于非集合的类型，我们避免使用这些词，因为它们可能会被解释为~\eqref{eq:injective}，这是对非集合类型不合适的概念。
同样地，任何集合之间的函数如果且仅如果它是一个适当意义上的 \emph{上同态 (epimorphism)}，则它是满射，但这对更一般的类型来说也是不成立的，并且满射通常是更重要的概念。

\begin{thm}\label{thm:mono-surj-equiv}
一个函数 $f:A\to B$ 当且仅当它既是满射又是嵌入时是等价的。
\end{thm}
\begin{proof}
  如果 $f$ 是等价的，那么每个 $\hfib f b$ 都是收缩的，因此 $\brck{\hfib f b}$ 也是收缩的，因此 $f$ 是满射的。
  我们在 \cref{thm:paths-respects-equiv} 中证明了任何等价都是嵌入的。

  反之，假设 $f$ 是一个满射嵌入。
  设 $b:B$；我们证明 $\sm{x:A}(f(x)=b)$ 是收缩的。
  因为 $f$ 是满射的，所以仅存在一个 $a:A$ 使得 $f(a)=b$。
  因此，$f$ 在 $b$ 上的纤维是非空的；剩下的是证明它是一个单纯命题。
  为此，假设给定 $x,y:A$ 且 $p:f(x)=b$ 和 $q:f(y)=b$。
  然后由于 $\apfunc f$ 是一个等价的，存在 $r:x=y$ 使得 $\apfunc f (r) = p \ct \opp q$。
  然而，使用在 $\Sigma$-类型中的路径表征，后者等式重新排列为 $\trans{r}{p} = q$。
  因此，连同 $r$ 一起，它展示了在 $f$ 在 $b$ 上的纤维中的 $(x,p) = (y,q)$。
\end{proof}

\begin{cor}
  对于任意 $f:A\to B$ 我们有
  \[ \isequiv(f) \eqvsym (\mathsf{isEmbedding}(f) \times \mathsf{isSurjective}(f))。\]
\end{cor}
\begin{proof}
  作为一个满射和嵌入都是单纯命题；现在应用 \cref{lem:equiv-iff-hprop}。
\end{proof}

当然，这不能用作“等价”的定义，因为嵌入的定义涉及到等价的概念。
然而，这个表征仍然是有用的；参见 \cref{sec:whitehead}。
我们将在 \cref{cha:hlevels} 中对其进行推广。

% \section{Fiberwise equivalences}
\section{等价的闭包性质 (Closure properties of equivalences)}
\label{sec:equiv-closures}
\label{sec:fiberwise-equivalences}
\index{equivalence!properties of}%

我们已经在 \cref{thm:equiv-eqrel} 中看到，等价关系在复合下是封闭的。
此外，我们还有：

\begin{thm}[三选二性质 (The 2-out-of-3 property)]\label{thm:two-out-of-three}
\index{2-out-of-3 property}%
假设 $f:A\to B$ 和 $g:B\to C$。
如果 $f$、$g$ 和 $g\circ f$ 中的任意两个是等价的，那么第三个也是等价的。
\end{thm}
\begin{proof}
  如果 $g\circ f$ 和 $g$ 是等价的，那么 $\opp{(g\circ f)} \circ g$ 是 $f$ 的准逆 (quasi-inverse)。
  一方面，我们有 $\opp{(g\circ f)} \circ g \circ f \htpy \idfunc[A]$，而另一方面我们有
  \begin{align*}
    f \circ \opp{(g\circ f)} \circ g
    &\htpy \opp g \circ g \circ f \circ \opp{(g\circ f)} \circ g\\
    &\htpy \opp g \circ g\\
    &\htpy \idfunc[B].
  \end{align*}
  同样地，如果 $g\circ f$ 和 $f$ 是等价的，那么 $f\circ \opp{(g\circ f)}$ 是 $g$ 的准逆。
\end{proof}

这是同伦理论中关于等价的一个标准闭包条件。
同样众所周知的是，它们在以下意义下对于再牵引 (retracts) 也是封闭的。

\index{retract!of a function|(defstyle)}%

\begin{defn}\label{defn:retract}
若有一个图
\begin{equation*}
  \xymatrix{
      {A} \ar[r]^{s} \ar[d]_{g}
    &
      {X} \ar[r]^{r} \ar[d]_{f}
    &
      {A} \ar[d]^{g}
    \\
    {B} \ar[r]_{s'}
    &
      {Y} \ar[r]_{r'}
    &
      {B}
  }
\end{equation*}
则称函数 $g:A\to B$ 是函数 $f:X\to Y$ 的 \define{再牵引 (retract)}，其中存在
\begin{enumerate}
  \item 一个同伦 $R:r\circ s \htpy \idfunc[A]$。
  \item 一个同伦 $R':r'\circ s' \htpy\idfunc[B]$。
  \item 一个同伦 $L:f\circ s\htpy s'\circ g$。
  \item 一个同伦 $K:g\circ r\htpy r'\circ f$。
  \item 对于每个 $a:A$，存在一个路径 $H(a)$ 见证下图的交换性
  \begin{equation*}
    \xymatrix@C=3pc{
        {g(r(s(a)))} \ar@{=}[r]^-{K(s(a))} \ar@{=}[d]_{\ap g{R(a)}}
      &
        {r'(f(s(a)))} \ar@{=}[d]^{\ap{r'}{L(a)}}
      \\
      {g(a)} \ar@{=}[r]_-{\opp{R'(g(a))}}
      &
        {r'(s'(g(a)))}
    }
  \end{equation*}
\end{enumerate}
\end{defn}

回顾一下，在 \cref{sec:contractibility} 中我们定义了类型如何成为另一类型的再牵引。
这是上述定义的一个特例，其中 $B$ 和 $Y$ 是 $\unit$。
相反，正如与可收缩性一样，映射的再牵引会诱导其纤维的再牵引。

\begin{lem}\label{lem:func_retract_to_fiber_retract}
如果函数 $g:A\to B$ 是函数 $f:X\to Y$ 的再牵引，那么对于每个 $b:B$，$\hfib{g}b$ 是 $\hfib{f}{s'(b)}$ 的再牵引，其中 $s':B\to Y$ 如 \cref{defn:retract} 所述。
\end{lem}

\begin{proof}
  假设 $g:A\to B$ 是 $f:X\to Y$ 的再牵引。那么对于任何 $b:B$，我们有函数
  \begin{align*}
    \varphi_b &:\hfiber{g}b\to\hfib{f}{s'(b)}, &
    \varphi_b(a,p) & \defeq \pairr{s(a),L(a)\ct s'(p)},\\
    \psi_b &:\hfib{f}{s'(b)}\to\hfib{g}b, &
    \psi_b(x,q) &\defeq \pairr{r(x),K(x)\ct r'(q)\ct R'(b)}.
  \end{align*}
  那么我们有 $\psi_b(\varphi_b({a,p}))\equiv\pairr{r(s(a)),K(s(a))\ct r'(L(a)\ct s'(p))\ct R'(b)}$。
  我们声称 $\psi_b$ 是一个具有截面的再牵引 $\varphi_b$ 对于所有 $b:B$，也就是说，对于所有 $(a,p):\hfib g b$，我们有 $\psi_b(\varphi_b({a,p}))= \pairr{a,p}$。
  换句话说，我们要证明
  \begin{equation*}
    \prd{b:B}{a:A}{p:g(a)=b} \psi_b(\varphi_b({a,p}))= \pairr{a,p}。
  \end{equation*}
  通过重新排列前两个 $\Pi$ 并应用 \cref{thm:omit-contr} 的一个版本，这等价于
  \begin{equation*}
    \prd{a:A}\psi_{g(a)}(\varphi_{g(a)}({a,\refl{g(a)}}))=\pairr{a,\refl{g(a)}}。
  \end{equation*}
  对于任何 $a$，根据 \cref{thm:path-sigma}，这个对偶对等价于一对等式。由于 $R(a):r(s(a))= a$，所以我们只需要证明
  \begin{equation*}
    \trans{R(a)}{K(s(a))\ct r'(L(a))\ct R'(g(a))} = \refl{g(a)}。
  \end{equation*}
  但这种变换计算为 $\opp{g(R(a))}\ct K(s(a))\ct r'(L(a))\ct R'(g(a))$，所以所需的路径由 $H(a)$ 给出。
\end{proof}

\begin{thm}\label{thm:retract-equiv}
如果 $g$ 是等价映射 $f$ 的再牵引，那么 $g$ 也是等价映射。
\end{thm}
\begin{proof}
  根据 \cref{lem:func_retract_to_fiber_retract}，$g$ 的每个纤维都是 $f$ 的纤维的再牵引。
  因此，根据 \cref{thm:retract-contr}，如果后者都是可收缩的，那么前者也是。
\end{proof}

\index{retract!of a function|)}%

\index{fibration}%
\index{total!space}%
最后，我们展示了纤维等价性 (fiberwise equivalences) 可以通过全空间等价 (equivalences of total spaces) 来表征。
为了解释这个术语，回顾 \cref{sec:fibrations}，其中类型族 $P:A\to\type$ 可以看作是 $A$ 上的一个纤维丛，其全空间为 $\sm{x:A} P(x)$，纤维丛的投影为 $\proj1:\sm{x:A} P(x) \to A$。
从这个角度来看，给定两个类型族 $P,Q:A\to\type$，我们可以称函数 $f:\prd{x:A} (P(x)\to Q(x))$ 为 \define{纤维映射 (fiberwise map)} 或 \define{纤维变换 (fiberwise transformation)}。
\indexsee{transformation!fiberwise}{fiberwise transformation}%
\indexsee{function!fiberwise}{fiberwise transformation}%
\index{fiberwise!transformation|(defstyle}%
\indexsee{fiberwise!map}{fiberwise transformation}%
\indexsee{map!fiberwise}{fiberwise transformation}
这样的映射在全空间上诱导一个函数：

\begin{defn}\label{defn:total-map}
给定类型族 $P,Q:A\to\type$ 和一个映射 $f:\prd{x:A} P(x)\to Q(x)$，我们定义
\begin{equation*}
  \total f  \defeq \lam{w}\pairr{\proj{1}w,f(\proj{1}w,\proj{2}w)} : \sm{x:A}P(x)\to\sm{x:A}Q(x)。
\end{equation*}
\end{defn}

\begin{thm}\label{fibwise-fiber-total-fiber-equiv}
假设 $f$ 是类型 $A$ 上族 $P$ 和 $Q$ 之间的一个纤维变换，并设 $x:A$ 和 $v:Q(x)$。那么我们有一个等价关系
\begin{equation*}
  \eqv{\hfib{\total{f}}{\pairr{x,v}}}{\hfib{f(x)}{v}}。
\end{equation*}
\end{thm}
\begin{proof}
  我们计算如下：
  \begin{align}
    \hfib{\total{f}}{\pairr{x,v}}
    & \jdeq \sm{w:\sm{x:A}P(x)}\pairr{\proj{1}w,f(\proj{1}w,\proj{2}w)}=\pairr{x,v}。
    \notag \\
    & \eqv{}{} \sm{a:A}{u:P(a)}\pairr{a,f(a,u)}=\pairr{x,v}。
    \tag{by~\cref{ex:sigma-assoc}} \\
    & \eqv{}{} \sm{a:A}{u:P(a)}{p:a=x}\trans{p}{f(a,u)}=v。
    \tag{by \cref{thm:path-sigma}} \\
    & \eqv{}{} \sm{a:A}{p:a=x}{u:P(a)}\trans{p}{f(a,u)}=v。
    \notag \\
    & \eqv{}{} \sm{u:P(x)}f(x,u)=v。
    \tag{$*$}\label{eq:uses-sum-over-paths} \\
    & \jdeq \hfib{f(x)}{v}。 \notag
  \end{align}
  等式~\eqref{eq:uses-sum-over-paths} 由 \cref{thm:omit-contr,thm:contr-paths,ex:sigma-assoc} 得出。
\end{proof}

我们称纤维变换 $f:\prd{x:A} P(x)\to Q(x)$ 为 \define{纤维等价 (fiberwise equivalence)}%
\indexdef{fiberwise!equivalence}%
\indexdef{equivalence!fiberwise}%
如果每个 $f(x):P(x) \to Q(x)$ 是一个等价。

\begin{thm}\label{thm:total-fiber-equiv}
假设 $f$ 是类型 $A$ 上族 $P$ 和 $Q$ 之间的一个纤维变换。
则 $f$ 是纤维等价当且仅当 $\total{f}$ 是等价映射。
\end{thm}

\begin{proof}
  设 $f$、$P$、$Q$ 和 $A$ 如定理所述。
  根据 \cref{fibwise-fiber-total-fiber-equiv}，对所有 $x:A$ 和 $v:Q(x)$，$\hfib{\total{f}}{\pairr{x,v}}$ 可收缩当且仅当 $\hfib{f(x)}{v}$ 可收缩。
  因此，$\hfib{\total{f}}{w}$ 对所有 $w:\sm{x:A}Q(x)$ 可收缩当且仅当 $\hfib{f(x)}{v}$ 对所有 $x:A$ 和 $v:Q(x)$ 可收缩。
\end{proof}

\index{fiberwise!transformation|)}%

\section{对象分类器 (The object classifier)}
\label{sec:object-classification}

在类型论中，我们有一个基本的“类型族”的概念，即函数 $B:A\to\type$。
我们已经看到，这样的族在某种程度上类似于同伦理论中的纤维丛 (fibration)，纤维丛为投影 $\proj1:\sm{a:A} B(a) \to A$。
同伦理论中的一个基本事实是每个映射都等价于一个纤维丛。
借助单值化 (univalence)，我们可以在类型论中证明同样的事情。

\begin{lem}\label{thm:fiber-of-a-fibration}
对于任意类型族 $B:A\to\type$，$\proj1:\sm{x:A} B(x) \to A$ 在 $a:A$ 处的纤维等价于 $B(a)$：
\[ \eqv{\hfib{\proj1}{a}}{B(a)} \]
\end{lem}
\begin{proof}
  我们有
  \begin{align*}
    \hfib{\proj1}{a} &\defeq \sm{u:\sm{x:A} B(x)} \proj1(u)=a\\
    &\eqvsym \sm{x:A}{b:B(x)} (x=a)\\
    &\eqvsym \sm{x:A}{p:x=a} B(x)\\
    &\eqvsym B(a)
  \end{align*}
  使用恒等类型的左泛性质 (left universal property)。
\end{proof}

\begin{lem}\label{thm:total-space-of-the-fibers}
对于任意函数 $f:A\to B$，我们有 $\eqv{A}{\sm{b:B}\hfib{f}{b}}$。
\end{lem}
\begin{proof}
  我们有
  \begin{align*}
    \sm{b:B}\hfib{f}{b} &\defeq \sm{b:B}{a:A} (f(a)=b)\\
    &\eqvsym \sm{a:A}{b:B} (f(a)=b)\\
    &\eqvsym A
  \end{align*}
  利用 $\sm{b:B} (f(a)=b)$ 是可收缩的事实。
\end{proof}

\begin{thm}\label{thm:nobject-classifier-appetizer}
对于任意类型 $B$，存在一个等价
\begin{equation*}
  \chi:\Parens{\sm{A:\type} (A\to B)}\eqvsym (B\to\type)。
\end{equation*}
\end{thm}
\begin{proof}
  我们需要构造准逆
  \begin{align*}
    \chi & : \Parens{\sm{A:\type} (A\to B)}\to B\to\type\\
    \psi & : (B\to\type)\to\Parens{\sm{A:\type} (A\to B)}。
  \end{align*}
  我们定义 $\chi$ 为 $\chi((A,f),b)\defeq\hfiber{f}b$，定义 $\psi$ 为 $\psi(P)\defeq\Pairr{(\sm{b:B} P(b)),\proj1}$。
  现在我们需要验证 $\chi\circ\psi\htpy\idfunc{}$ 和 $\psi\circ\chi \htpy\idfunc{}$。
  \begin{enumerate}
    \item 设 $P:B\to\type$。
    通过 \cref{thm:fiber-of-a-fibration}，
    $\hfiber{\proj1}{b}\eqvsym P(b)$ 对于任意 $b:B$，所以这立即得出
    $P\htpy\chi(\psi(P))$。
    \item 设 $f:A\to B$ 是一个函数。我们需要找到一个路径
    \begin{equation*}
      \Pairr{\tsm{b:B} \hfiber{f}b,\,\proj1}=\pairr{A,f}。
    \end{equation*}
    首先注意到，通过 \cref{thm:total-space-of-the-fibers}，我们有
    $e:\sm{b:B} \hfiber{f}b\eqvsym A$，定义为 $e(b,a,p)\defeq a$ 和 $e^{-1}(a)
    \defeq(f(a),a,\refl{f(a)})$。
    根据 \cref{thm:path-sigma}，剩下的部分是要证明 $\trans{(\ua(e))}{\proj1} = f$。
    但通过单值化的计算规则和~\eqref{eq:transport-arrow}，我们有 $\trans{(\ua(e))}{\proj1} = \proj1\circ e^{-1}$，并且 $e^{-1}$ 的定义立即得出 $\proj1 \circ e^{-1} \jdeq f$。\qedhere
  \end{enumerate}
\end{proof}

\noindent
\indexdef{object!classifier}%
\indexdef{classifier!object}%
\index{.infinity1-topos@$(\infty,1)$-topos}%
特别地，这意味着我们在更高拓扑论 (higher topos theory) 的意义上有一个对象分类器 (object classifier)。
回顾 \cref{def:pointedtype} 中 $\pointed\type$ 表示带指点类型的类型 $\sm{A:\type} A$。

\begin{thm}\label{thm:object-classifier}
设 $f:A\to B$ 是一个函数。则图
\begin{equation*}
  \vcenter{\xymatrix{
    A\ar[r]^-{\vartheta_f} \ar[d]_{f} &
    \pointed{\type}\ar[d]^{\proj1}\\
    B\ar[r]_{\chi_f} &
    \type
  }}
\end{equation*}
是一个拉回方块 (pullback square)（见 \cref{ex:pullback}）。
其中函数 $\vartheta_f$ 定义为
\begin{equation*}
  \lam{a} \pairr{\hfiber{f}{f(a)},\pairr{a,\refl{f(a)}}}。
\end{equation*}
\end{thm}
\begin{proof}
  注意我们有等价关系
  \begin{align*}
    A & \eqvsym \sm{b:B} \hfiber{f}b\\
    & \eqvsym \sm{b:B}{X:\type}{p:\hfiber{f}b= X} X\\
    & \eqvsym \sm{b:B}{X:\type}{x:X} \hfiber{f}b= X\\
    & \eqvsym \sm{b:B}{Y:\pointed{\type}} \hfiber{f}b = \proj1 Y\\
    & \jdeq B\times_{\type}\pointed{\type}
  \end{align*}
  这给我们一个复合等价 $e:A\eqvsym B\times_\type\pointed{\type}$。
  我们可以通过以下步骤逐步显示这个复合等价的操作：
  \begin{align*}
    a & \mapsto \pairr{f(a),\; \pairr{a,\refl{f(a)}}}\\
    & \mapsto \pairr{f(a), \; \hfiber{f}{f(a)}, \; \refl{\hfiber{f}{f(a)}}, \; \pairr{a,\refl{f(a)}}}\\
    & \mapsto \pairr{f(a), \; \hfiber{f}{f(a)}, \; \pairr{a,\refl{f(a)}}, \; \refl{\hfiber{f}{f(a)}}}。
  \end{align*}
  因此，我们得到同伦 $f\htpy\proj1\circ e$ 和 $\vartheta_f\htpy \proj2\circ e$。
\end{proof}



\section{Univalence implies function extensionality}
\label{sec:univalence-implies-funext}

\index{function extensionality!proof from univalence}%
In the last section of this chapter we include a proof that the univalence axiom implies function
extensionality. Thus, in this section we work \emph{without} the function extensionality axiom.
The proof consists of two steps. First we show
in \cref{uatowfe} that the univalence
axiom implies a weak form of function extensionality, defined in \cref{weakfunext} below. The
principle of weak function extensionality in turn implies the usual function extensionality,
and it does so without the univalence axiom (\cref{wfetofe}).

\index{univalence axiom}%
Let $\type$ be a universe; we will explicitly indicate where we assume that it is univalent.

\begin{defn}\label{weakfunext}
The \define{weak function extensionality principle}
\indexdef{function extensionality!weak}%
asserts that there is a function
\begin{equation*}
\Parens{\prd{x:A}\iscontr(P(x))} \to\iscontr\Parens{\prd{x:A}P(x)}
\end{equation*}
for any family $P:A\to\type$ of types over any type $A$.
\end{defn}

The following lemma is easy to prove using function extensionality; the point here is that it also follows from univalence without assuming function extensionality separately.

\begin{lem} \label{UA-eqv-hom-eqv}
Assuming $\type$ is univalent, for any $A,B,X:\type$ and any $e:\eqv{A}{B}$, there is an equivalence
\begin{equation*}
\eqv{(X\to A)}{(X\to B)}
\end{equation*}
of which the underlying map is given by post-composition with the underlying function of $e$.
\end{lem}

\begin{proof}
  % Immediate by induction on $\eqv{}{}$ (see \cref{thm:equiv-induction}).
  As in the proof of \cref{lem:qinv-autohtpy}, we may assume that $e = \idtoeqv(p)$ for some $p:A=B$.
  Then by path induction, we may assume $p$ is $\refl{A}$, so that $e = \idfunc[A]$.
  But in this case, post-composition with $e$ is the identity, hence an equivalence.
\end{proof}

\begin{cor}\label{contrfamtotalpostcompequiv}
Let $P:A\to\type$ be a family of contractible types, i.e.\ \narrowequation{\prd{x:A}\iscontr(P(x)).}
Then the projection $\proj{1}:(\sm{x:A}P(x))\to A$ is an equivalence. Assuming $\type$ is univalent, it follows immediately that post-composition with $\proj{1}$ gives an equivalence
\begin{equation*}
\alpha : \eqv{\Parens{A\to\sm{x:A}P(x)}}{(A\to A)}.
\end{equation*}
\end{cor}

\begin{proof}
  By \cref{thm:fiber-of-a-fibration}, for $\proj{1}:\sm{x:A}P(X)\to A$ and $x:A$ we have an equivalence
  \begin{equation*}
    \eqv{\hfiber{\proj{1}}{x}}{P(x)}.
  \end{equation*}
  Therefore $\proj{1}$ is an equivalence whenever each $P(x)$ is contractible. The assertion is now a consequence of  \cref{UA-eqv-hom-eqv}.
\end{proof}

In particular, the homotopy fiber of the above equivalence at $\idfunc[A]$ is contractible. Therefore, we can show that univalence implies weak function extensionality by showing that the dependent function type $\prd{x:A}P(x)$ is a retract of $\hfiber{\alpha}{\idfunc[A]}$.

\begin{thm}\label{uatowfe}
In a univalent universe $\type$, suppose that $P:A\to\type$ is a family of contractible types
and let $\alpha$ be the function of \cref{contrfamtotalpostcompequiv}.
Then $\prd{x:A}P(x)$ is a retract of $\hfiber{\alpha}{\idfunc[A]}$. As a consequence, $\prd{x:A}P(x)$ is contractible. In other words, the univalence axiom implies the weak function extensionality principle.
\end{thm}

\begin{proof}
Define the functions
\begin{align*}
  \varphi &: (\tprd{x:A}P(x))\to\hfiber{\alpha}{\idfunc[A]},\\
  \varphi(f) &\defeq (\lam{x} (x,f(x)),\refl{\idfunc[A]}),
\intertext{and}
  \psi &: \hfiber{\alpha}{\idfunc[A]}\to \tprd{x:A}P(x), \\
  \psi(g,p) &\defeq \lam{x} \trans {\happly (p,x)}{\proj{2} (g(x))}.
\end{align*}
Then $\psi(\varphi(f))=\lam{x} f(x)$, which is $f$, by the uniqueness principle for dependent function types.
\end{proof}

We now show that weak function extensionality implies the usual function extensionality.
Recall from~\eqref{eq:happly} the function $\happly (f,g) : (f = g)\to(f\htpy g)$ which
converts equality of functions to homotopy. In the proof that follows, the univalence
axiom is not used.

\begin{thm}\label{wfetofe}
  \index{function extensionality}%
Weak function extensionality implies the function extensionality \cref{axiom:funext}.
\end{thm}

\begin{proof}
We want to show that
\begin{equation*}
\prd{A:\type}{P:A\to\type}{f,g:\prd{x:A}P(x)}\isequiv(\happly (f,g)).
\end{equation*}
Since a fiberwise map induces an equivalence on total spaces if and only if it is fiberwise an equivalence by \cref{thm:total-fiber-equiv}, it suffices to show that the function of type
\begin{equation*}
\Parens{\sm{g:\prd{x:A}P(x)}(f= g)} \to \sm{g:\prd{x:A}P(x)}(f\htpy g)
\end{equation*}
induced by $\lam{g:\prd{x:A}P(x)} \happly (f,g)$ is an equivalence.
Since the type on the left is contractible by \cref{thm:contr-paths}, it suffices to show that the type on the right:
\begin{equation}\label{eq:uatofesp}
\sm{g:\prd{x:A}P(x)}\prd{x:A}f(x)= g(x)
\end{equation}
is contractible.
Now \cref{thm:ttac} says that this is equivalent to
\begin{equation}\label{eq:uatofeps}
\prd{x:A}\sm{u:P(x)}f(x)= u.
\end{equation}
The proof of \cref{thm:ttac} uses function extensionality, but only for one of the composites.
Thus, without assuming function extensionality, we can conclude that~\eqref{eq:uatofesp} is a retract\index{retract!of a type} of~\eqref{eq:uatofeps}.
And~\eqref{eq:uatofeps} is a product of contractible types, which is contractible by the weak function extensionality principle; hence~\eqref{eq:uatofesp} is also contractible.
\end{proof}

\sectionNotes

The fact that the space of continuous maps equipped with quasi-inverses has the wrong homotopy type to be the ``space of homotopy equivalences'' is well-known in algebraic topology.
In that context, the ``space of homotopy equivalences'' $(\eqv AB)$ is usually defined simply as the subspace of the function space $(A\to B)$ consisting of the functions that are homotopy equivalences.
In type theory, this would correspond most closely to $\sm{f:A\to B} \brck{\qinv(f)}$; see \cref{ex:brck-qinv}.

The first definition of equivalence given in homotopy type theory was the one that we have called $\iscontr(f)$, which was due to Voevodsky.
The possibility of the other definitions was subsequently observed by various people.
The basic theorems about adjoint equivalences\index{adjoint!equivalence} such as \cref{lem:coh-equiv,thm:equiv-iso-adj} are adaptations of standard facts in higher category theory and homotopy theory.
Using bi-invertibility as a definition of equivalences was suggested by Andr\'e Joyal.

The properties of equivalences discussed in \cref{sec:mono-surj,sec:equiv-closures} are well-known in homotopy theory.
Most of them were first proven in type theory by Voevodsky.

The fact that every function is equivalent to a fibration is a standard fact in homotopy theory.
The notion of object classifier
\index{object!classifier}%
\index{classifier!object}%
in $(\infty,1)$-category
\index{.infinity1-category@$(\infty,1)$-category}%
theory (the categorical analogue of \cref{thm:nobject-classifier-appetizer}) is due to Rezk (see~\cite{Rezk05,lurie:higher-topoi}).

Finally, the fact that univalence implies function extensionality (\cref{sec:univalence-implies-funext}) is due to Voevodsky.
Our proof is a simplification of his.
\cref{ex:funext-from-nondep} is also due to Voevodsky.

\sectionExercises

\begin{ex}\label{ex:two-sided-adjoint-equivalences}
  Consider the type of ``two-sided adjoint equivalence\index{adjoint!equivalence} data'' for $f:A\to B$,
  \begin{narrowmultline*}
    \sm{g:B\to A}{\eta: g \circ f \htpy \idfunc[A]}{\epsilon:f \circ g \htpy \idfunc[B]}
    \narrowbreak
    \Parens{\prd{x:A} \map{f}{\eta x} = \epsilon(fx)} \times
    \Parens{\prd{y:B} \map{g}{\epsilon y} = \eta(gy) }.
  \end{narrowmultline*}
  By \cref{lem:coh-equiv}, we know that if $f$ is an equivalence, then this type is inhabited.
  Give a characterization of this type analogous to \cref{lem:qinv-autohtpy}.

  Can you give an example showing that this type is not generally a mere proposition?
  (This will be easier after \cref{cha:hits}.)
\end{ex}

\begin{ex}\label{ex:symmetric-equiv}
  Show that for any $A,B:\UU$, the following type is equivalent to $\eqv A B$.
  \begin{equation*}
    \sm{R:A\to B\to \type}
    \Parens{\prd{a:A} \iscontr\Parens{\sm{b:B} R(a,b)}} \times
    \Parens{\prd{b:B} \iscontr\Parens{\sm{a:A} R(a,b)}}.
  \end{equation*}
  Can you extract from this a definition of a type satisfying the three desiderata of $\isequiv(f)$?
\end{ex}

\begin{ex} \label{ex:qinv-autohtpy-no-univalence}
  Reformulate the proof of \cref{lem:qinv-autohtpy} without using univalence.
\end{ex}

\begin{ex}[The unstable octahedral axiom]\label{ex:unstable-octahedron}
  \index{axiom!unstable octahedral}%
  \index{octahedral axiom, unstable}%
  Suppose $f:A\to B$ and $g:B\to C$ and $b:B$.
  \begin{enumerate}
  \item Show that there is a natural map $\hfib{g\circ f}{g(b)} \to \hfib{g}{g(b)}$ whose fiber over $(b,\refl{g(b)})$ is equivalent to $\hfib f b$.
  \item Show that $\eqv{\hfib{g\circ f}{c}}{\sm{w:\hfib{g}{c}} \hfib f {\proj1 w}}$.
  \end{enumerate}
\end{ex}

\begin{ex}\label{ex:2-out-of-6}
  \index{2-out-of-6 property}%
  Prove that equivalences satisfy the \emph{2-out-of-6 property}: given $f:A\to B$ and $g:B\to C$ and $h:C\to D$, if $g\circ f$ and $h\circ g$ are equivalences, so are $f$, $g$, $h$, and $h\circ g\circ f$.
  Use this to give a higher-level proof of \cref{thm:paths-respects-equiv}.
\end{ex}

\begin{ex}\label{ex:qinv-univalence}
  For $A,B:\UU$, define
  \[ \mathsf{idtoqinv}_{A,B} :(A=B) \to \sm{f:A\to B}\qinv(f) \]
  by path induction in the obvious way.
  Let \textbf{\textsf{qinv}-univalence} denote the modified form of the univalence axiom which asserts that for all $A,B:\UU$ the function $\mathsf{idtoqinv}_{A,B}$ has a quasi-inverse.
  \begin{enumerate}
  \item Show that \qinv-univalence can be used instead of univalence in the proof of function extensionality in \cref{sec:univalence-implies-funext}.
  \item Show that \qinv-univalence can be used instead of univalence in the proof of \cref{thm:qinv-notprop}.
  \item Show that \qinv-univalence is inconsistent (i.e.\ allows construction of an inhabitant of $\emptyt$).
    Thus, the use of a ``good'' version of $\isequiv$ is essential in the statement of univalence.
  \end{enumerate}
\end{ex}

\begin{ex}\label{ex:embedding-cancellable}
  Show that a function $f:A\to B$ is an embedding if and only if the following two conditions hold:
  \begin{enumerate}
  \item $f$ is \emph{left cancellable}, i.e.\ for any $x,y:A$, if $f(x)=f(y)$ then $x=y$.\label{item:ex:ec1}
  \item For any $x:A$, the map $\apfunc f: \Omega(A,x) \to \Omega(B,f(x))$ is an equivalence.\label{item:ex:ec2}
  \end{enumerate}
  (In particular, if $A$ is a set, then $f$ is an embedding if and only if it is left-cancellable and $\Omega(B,f(x))$ is contractible for all $x:A$.)
  Give examples to show that neither of~\ref{item:ex:ec1} or~\ref{item:ex:ec2} implies the other.
\end{ex}

\begin{ex}\label{ex:cancellable-from-bool}
  Show that the type of left-cancellable functions $\bool\to B$ (see \cref{ex:embedding-cancellable}) is equivalent to $\sm{x,y:B}(x\neq y)$.
  Give a similar explicit characterization of the type of embeddings $\bool\to B$.
\end{ex}

\begin{ex}\label{ex:funext-from-nondep}
  The \textbf{na\"{i}ve non-dependent function extensionality axiom} says that for $A,B:\type$ and $f,g:A\to B$ there is a function $(\prd{x:A} f(x)=g(x)) \to (f=g)$.
  \indexdef{function extensionality!non-dependent}%
  Modify the argument of \cref{sec:univalence-implies-funext} to show that this axiom implies the full function extensionality axiom (\cref{axiom:funext}).
\end{ex}

% Local Variables:
% TeX-master: "hott-online"
% End:
